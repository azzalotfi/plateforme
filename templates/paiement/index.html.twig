<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ asset('css/styl.css') }}">
    <title>Paiement</title>
</head>
<body>
{% include 'partials/header.html.twig' %}

{% if app.user %}
<div class="container">

    <!-- Message succÃ¨s/erreur -->
    <div id="payment-message" style="text-align:center; margin-bottom:15px;"></div>

    <!-- Carte animÃ©e -->
    <div class="card-container">
        <div class="front">
            <div class="image">
                <img src="{{ asset('images/chip.png') }}" alt="chip">
                <img src="{{ asset('images/visa.png') }}" alt="visa logo" class="logo">
            </div>
            <div class="card-number-box">#### #### #### ####</div>
            <div class="flexbox">
                <div class="box">
                    <span>Card Holder</span>
                    <div class="card-holder-name">full name</div>
                </div>
                <div class="box">
                    <span>Expires</span>
                    <div class="expiration">
                        <span class="exp-month">mm</span>/<span class="exp-year">yy</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="back">
            <div class="stripe"></div>
            <div class="box">
                <span>CVV</span>
                <div class="cvv-box"></div>
                <img src="{{ asset('images/visa.png') }}" alt="visa logo" class="logo-back">
            </div>
        </div>
    </div>

    <!-- Formulaire de paiement -->
    <form id="payment-form">
        <div class="inputBox">
    <span>Card Number</span>
    <div style="position:relative;">
        <input type="text" id="card-number" maxlength="19" placeholder="#### #### #### ####" required
               oninput="this.value=this.value.replace(/[^0-9]/g,'').replace(/(.{4})/g,'$1 ').trim(); detectCardType(); showCard();">
        <img id="card-logo" src="{{ asset('images/default-card.png') }}" 
             style="position:absolute; right:10px; top:50%; transform:translateY(-50%); height:24px;" alt="Card Logo">
    </div>
</div>

        <div class="inputBox">
            <span>Card Holder</span>
            <input type="text" id="card-holder-name" placeholder="Full Name" required>
        </div>

        <div class="flexbox">
            <div class="inputBox">
                <span>Expiration Month</span>
                <select id="exp-month" required>
                    <option value="" disabled selected>Month</option>
                    {% for m in 1..12 %}
                        <option value="{{ '%02d'|format(m) }}">{{ '%02d'|format(m) }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="inputBox">
                <span>Expiration Year</span>
                <select id="exp-year" required>
                    <option value="" disabled selected>Year</option>
                    {% for y in 2024..2035 %}
                        <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="inputBox">
                <span>CVV</span>
                <input type="text" id="cvv" maxlength="4" placeholder="123" required>
            </div>
            <div class="inputBox">
                <span>Montant (â‚¬)</span>
                <input type="number" id="amount" min="1" placeholder="Ex: 10" required>
            </div>
        </div>

        <button type="submit" class="submit-btn">Pay</button>
    </form>
</div>

{% else %}
<div style="text-align:center; margin-top:50px;">
    <h2>Vous devez Ãªtre connectÃ© pour accÃ©der au paiement.</h2>
    <a href="{{ path('app_login') }}" class="btn btn-primary">Se connecter</a>
</div>
{% endif %}

{% include 'partials/footer.html.twig' %}

<script>
// ==================== Variables ====================
const form = document.getElementById('payment-form');
const cardNumberInput = document.getElementById('card-number');
const cardHolderInput = document.getElementById('card-holder-name');
const expMonthInput = document.getElementById('exp-month');
const expYearInput = document.getElementById('exp-year');
const cvvInput = document.getElementById('cvv');
const amountInput = document.getElementById('amount');
const cardLogo = document.getElementById('card-logo');
const messageDiv = document.getElementById('payment-message');

// ==================== Affichage carte ====================
cardNumberInput.addEventListener('input', e => document.querySelector('.card-number-box').innerText = e.target.value || '#### #### #### ####');
cardHolderInput.addEventListener('input', e => document.querySelector('.card-holder-name').innerText = e.target.value || 'full name');
expMonthInput.addEventListener('input', e => document.querySelector('.exp-month').innerText = e.target.value);
expYearInput.addEventListener('input', e => document.querySelector('.exp-year').innerText = e.target.value);
cvvInput.addEventListener('input', e => document.querySelector('.cvv-box').innerText = e.target.value);

// Flip card pour CVV
cvvInput.addEventListener('mouseenter', () => {
    document.querySelector('.front').style.transform = 'perspective(1000px) rotateY(-180deg)';
    document.querySelector('.back').style.transform = 'perspective(1000px) rotateY(0deg)';
});
cvvInput.addEventListener('mouseleave', () => {
    document.querySelector('.front').style.transform = 'perspective(1000px) rotateY(0deg)';
    document.querySelector('.back').style.transform = 'perspective(1000px) rotateY(180deg)';
});

// ==================== DÃ©tection type de carte ====================

function detectCardType() {
    const value = cardNumberInput.value.replace(/\s+/g,''); // supprimer espaces
    let type = 'default-card.png'; // dÃ©faut

    if (/^4[0-9]{0,}$/.test(value)) {
        type = 'visa1.png';
    } else if (/^5[1-5][0-9]{0,}$/.test(value)) {
        type = 'mastercard.png';
    } else if (/^3[47][0-9]{0,}$/.test(value)) {
        type = 'amex.png';
    } else if (/^6(?:011|5[0-9]{2})[0-9]{0,}$/.test(value)) {
        type = 'discover.png';
    }
    cardLogo.src = "{{ asset('images/') }}" + type;
}

// ==================== Affichage message ====================
function showMessage(msg, type){
    messageDiv.innerText = msg;
    messageDiv.style.color = type === 'success' ? '#4CAF50' : '#f44336';
    messageDiv.style.fontWeight = 'bold';
    messageDiv.style.fontSize = '16px';
    messageDiv.style.opacity = '1';
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(()=>messageDiv.innerText='',500);
    }, 5000);
}

// ==================== Submit paiement AJAX ====================


// Submit paiement
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
        amount: parseInt(amountInput.value) * 100, // centimes
        paymentToken: "tok_visa" // token test
    };

    try {
        const response = await fetch("{{ path('paiement_submit') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            showMessage(`Paiement rÃ©ussi ! Points ajoutÃ©s : ${result.points}`, 'success');

            // ðŸ”¹ RÃ©initialiser le formulaire
            form.reset();

            // ðŸ”¹ RÃ©initialiser la carte visuelle
            document.querySelector('.card-number-box').innerText = '#### #### #### ####';
            document.querySelector('.card-holder-name').innerText = 'full name';
            document.querySelector('.exp-month').innerText = 'mm';
            document.querySelector('.exp-year').innerText = 'yy';
            document.querySelector('.cvv-box').innerText = '';

            // ðŸ”¹ RÃ©initialiser logo de carte
            document.getElementById('card-logo').src = "{{ asset('images/default-card.png') }}";
        } else {
            showMessage(`Erreur : ${result.message}`, 'error');
        }
    } catch (err) {
        showMessage(`Erreur serveur : ${err.message}`, 'error');
    }
});
</script>
</body>
</html>
