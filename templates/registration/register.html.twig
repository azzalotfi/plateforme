{% extends 'base.html.twig' %}

{% block title %}Inscription - ServicePro{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="{{ asset('css/register.css') }}" rel="stylesheet">
    <link href="{{ asset('css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
{% include 'partials/header.html.twig' %}
<div class="register-container">
    
    

    <!-- MAIN -->
    <main class="main">
        <!-- LEFT SECTION -->
        <section class="left-section">
            <div class="badge">üöÄ Rejoignez ServicePro</div>
            <h1>Commencez d√®s aujourd‚Äôhui</h1>
            <p>Cr√©ez votre compte et d√©couvrez tous nos services professionnels</p>

            <div class="stats">
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <h3>5000+</h3>
                    <p>Utilisateurs actifs</p>
                </div>
                <div class="stat-card">
                    <div class="icon">üîí</div>
                    <h3>100%</h3>
                    <p>Paiement s√©curis√©</p>
                </div>
            </div>
            <img src="{{ asset('images/office.jpg') }}" alt="Bureau ServicePro" class="illustration">

        </section>

        <!-- RIGHT SECTION (FORM) -->
        <section class="form-section">
            <h2>Cr√©er un compte</h2>
            <p>Rejoignez ServicePro d√®s maintenant</p>

            <form id="register-form" method="post" action="{{ path('app_register') }}" novalidate>
                <div class="form-group" data-help="Entrez votre nom complet (2 lettres min)">
                    <input class="input-field" type="text" name="nom" placeholder="Votre nom" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="form-group" data-help="Votre adresse e‚Äëmail (ex: vous@mail.com)">
                    <input class="input-field" type="email" name="email" placeholder="Email" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="form-group" data-help="Votre num√©ro de t√©l√©phone (ex: 0612345678)">
                    <input class="input-field" type="tel" name="tel" placeholder="T√©l√©phone" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="form-group" data-help="Votre adresse compl√®te">
                    <input class="input-field" type="text" name="adresse" placeholder="Adresse" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="form-group" data-help="Min 6 caract√®res, lettres + chiffres">
                    <input class="input-field" type="password" name="password" placeholder="Mot de passe" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="form-group" data-help="Retapez le m√™me mot de passe">
                    <input class="input-field" type="password" name="confirm_password" placeholder="Confirmer mot de passe" />
                    <div class="form-tooltip" aria-hidden="true"></div>
                </div>

                <div class="role-select">
                    <div class="role-option active" data-role="client">
                        <i class="bi bi-person"></i>
                        <span>Client</span>
                    </div>
                    <div class="role-option" data-role="prestataire">
                        <i class="bi bi-briefcase"></i>
                        <span>Prestataire</span>
                    </div>
                    <input type="hidden" name="role" value="client" id="role-input">
                </div>

                <button type="submit" class="submit-btn">S'inscrire</button>
            </form>

            <div class="login-link">
                D√©j√† membre ? <a href="{{ path('app_login') }}">Connectez-vous</a>
            </div>
        </section>
    </main>

    <!-- HELP BUTTON -->
    <button class="help-btn">?</button>
</div>
{% include 'partials/footer.html.twig' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('register-form');
    if (!form) return;

    // initialiser les tooltips avec data-help
    form.querySelectorAll('.form-group').forEach(group => {
        const tip = group.querySelector('.form-tooltip');
        if (tip) tip.textContent = group.dataset.help || '';
    });

    function setError(input, message) {
        const g = input.closest('.form-group');
        if (!g) return;
        g.dataset.error = message;
        g.querySelector('.form-tooltip').textContent = message;
        input.classList.add('error');
    }
    function clearError(input) {
        const g = input.closest('.form-group');
        if (!g) return;
        delete g.dataset.error;
        g.querySelector('.form-tooltip').textContent = g.dataset.help || '';
        input.classList.remove('error');
    }

    function validate(input) {
        const name = input.name;
        const v = (input.value || '').trim();
        if (name === 'nom') {
            if (!v || !/^[A-Za-z\s]{2,}$/.test(v)) { setError(input, 'Le nom doit contenir au moins 2 lettres.'); return false; }
        } else if (name === 'email') {
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) { setError(input, 'Adresse e‚Äëmail invalide.'); return false; }
        } else if (name === 'tel') {
            // Validation t√©l√©phone : au moins 8 chiffres, peut contenir +, espaces, tirets, points
            const telClean = v.replace(/[\s\-\.\(\)]/g, '');
            if (v && (!/^[\+]?[0-9]{8,15}$/.test(telClean) || telClean.length < 8)) { 
                setError(input, 'Num√©ro de t√©l√©phone invalide (min 8 chiffres).'); 
                return false; 
            }
        } else if (name === 'adresse') {
            // Validation adresse : au moins 5 caract√®res
            if (v && v.length < 5) { 
                setError(input, 'L\'adresse doit contenir au moins 5 caract√®res.'); 
                return false; 
            }
        } else if (name === 'password') {
            if (!/^(?=.*[A-Za-z])(?=.*\d).{6,}$/.test(v)) { setError(input, 'Min 6 caract√®res, lettres et chiffres.'); return false; }
        } else if (name === 'confirm_password') {
            const pass = form.querySelector('input[name="password"]').value || '';
            if (v !== pass) { setError(input, 'Les mots de passe ne correspondent pas.'); return false; }
        }
        clearError(input);
        return true;
    }

    // validation live
    form.querySelectorAll('.input-field').forEach(inp => {
        inp.addEventListener('input', () => validate(inp));
        // mettre le tooltip √† jour au survol (utile si help change)
        inp.addEventListener('mouseenter', () => {
            const g = inp.closest('.form-group');
            if (!g) return;
            const tip = g.querySelector('.form-tooltip');
            tip.textContent = g.dataset.error ? g.dataset.error : (g.dataset.help || '');
        });
    });

    // S√©lection du r√¥le (Client / Prestataire)
    const roleOptions = document.querySelectorAll('.role-option');
    const roleInput = document.getElementById('role-input');

    roleOptions.forEach(option => {
        option.addEventListener('click', () => {
            roleOptions.forEach(o => o.classList.remove('active'));
            option.classList.add('active');
            roleInput.value = option.dataset.role;
        });
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        let ok = true;
        form.querySelectorAll('.input-field').forEach(inp => { if (!validate(inp)) ok = false; });
        if (!ok) {
            const f = form.querySelector('.input-field.error');
            if (f) f.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // D√©sactiver le bouton pendant l'envoi
        const submitBtn = form.querySelector('.submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Inscription en cours...';

        // Cr√©er FormData √† partir du formulaire
        const formData = new FormData(form);

        // Envoyer la requ√™te AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Rediriger vers la page de connexion
                window.location.href = data.redirect || '{{ path("app_login") }}';
            } else {
                // Afficher l'erreur
                alert(data.message || 'Une erreur est survenue lors de l\'inscription.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue. Veuillez r√©essayer.');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
        });
    });
</script>

{% endblock %}
